#!/usr/bin/env bash

source ~/workstation/bin/common.sh

if [ -z "$CONCOURSE_TARGET" ]; then
  echo "Please set CONCOURSE_TARGET"
  exit 1
fi

function trigger-pipeline(){
  payload=$(fly -t $CONCOURSE_TARGET pipelines --json)
  pipeline=$1
  jobs=()

  if [[ -z $pipeline ]]; then
    pipeline=$(echo "$payload" | jq ".[] |.name" -r | sort | gum choose -q "Select pipeline")
  fi

  groups=$(echo "$payload" | jq ".[] | select(.name==\"$pipeline\") | .groups" -r)

  if [ "$groups" == "null" ]; then
    payload=$(fly -t app-autoscaler-release jobs -p "$pipeline" --json)
    job=$(echo "$payload" | jq ".[] | .name" -r | gum choose -q "Select job")
  else
    group=$(echo $groups | jq -r ".[] | .name" | gum choose -q "Select group")
    job=$(echo "$groups" | jq ".[] | select(.name==\"$group\")  | .jobs[]" -r | gum choose -q "Select job")
  fi


  fly -t $CONCOURSE_TARGET tj -j $pipeline/$job -w
}


trigger-pipeline "${@:-}"
