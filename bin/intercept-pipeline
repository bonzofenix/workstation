#!/bin/bash
set -e

if [ -z "$CONCOURSE_TARGET" ]; then
  echo "Please set CONCOURSE_TARGET"
  exit 1
fi

function run(){
  payload=$(fly -t $CONCOURSE_TARGET pipelines --json)
  pipeline=$(echo "$payload" | jq ".[] |.name" -r | sort | gum choose )
  group=$(echo "$payload" | jq ".[] | select(.name==\"$pipeline\") | .groups[] | .name" -r | gum choose)
  job=$(echo "$payload" | jq ".[] | select(.name==\"$pipeline\") | .groups[] | select(.name==\"$group\")  | .jobs[]" -r | gum choose)
  build=$(fly -t $CONCOURSE_TARGET builds -j $pipeline/$job --json | jq ".[] | .name" -r | head -n 1)
  fly -t $CONCOURSE_TARGET i -j $pipeline/$job -b $build
}

PIPELINE_DIR=$HOME/workspace/pipelines
TMP_DIR=$HOME/.book

run $1
